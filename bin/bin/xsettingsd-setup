#!/bin/sh
showdpi() {
    output=$1 pixels=$2 mm=$3
    dpi=$((pixels * 254 / 10 / mm))
    case $output in
        # For laptop screens, we need to apply a correction factor as the
        # screen is nearer
        eDP-1|eDP1) corrected=$((dpi * 96/144)) ;;
        *) corrected=$dpi ;;
    esac
    # Authorized factors: 1, 1.25, 1.5, 2, 3, 4, ...
    rounded=$(((corrected + 12) / 24 * 24))
    [ $rounded -gt 168 ] && rounded=$(((corrected + 48) / 96 * 96))
    [ $rounded -lt 96 ] && rounded=96
    echo "$output: ${dpi}dpi (corrected to ${corrected}dpi, rounded to ${rounded}dpi)" >&2
    echo "$rounded"
}

dpis=$(xrandr --current \
    | sed -En 's/^([^ ]+)* connected.* ([0-9]+)x.* ([0-9]+)mm x .*/\1 \2 \3/p' \
    | while read -r output pixels mm; do
    showdpi "$output" "$pixels" "$mm"
done | tr '\n' ' ')
dpi=${dpis%% *}
dpi=${dpi:-96}
echo "using ${dpi}dpi" >&2
xrandr --dpi "$dpi"
cfg="$XDG_CONFIG_HOME/xsettingsd/xsettingsd.conf"
{
    echo Xft.dpi: "$dpi"
    echo Xft.rgba: "$( [ "$dpi" -gt 144 ] && echo none || echo rgb )"
    echo 'Nsxiv.background:                 #000000'
    echo 'Nsxiv.font:                       Iosevka:style=Medium:size=17'
    echo 'Nsxiv.foreground:                 #3993AA'
    echo 'Nsxiv.selection:                  #342EB9'
    echo 'Nsxiv.window.alpha:               1.0'
    awk '/CursorThemeSize/{print "Xcursor.size: "$2}' "$XDG_CONFIG_HOME/xinit/xsettingsd"
    awk '/CursorThemeName/{print "Xcursor.theme: "$2}' "$XDG_CONFIG_HOME/xinit/xsettingsd" | tr -d '"'
} | xrdb -merge
{
    cat "$XDG_CONFIG_HOME/xinit/xsettingsd"
    echo Xft/DPI $((dpi*1024)) # 98304 for 27'' 4k is ok
    echo Xft/RGBA \""$( [ "$dpi" -gt 144 ] && echo none || echo rgb )"\"
    echo Gdk/WindowScalingFactor "$( [ "$dpi" -gt 144 ] && command echo -n 2 || command echo -n 1 )"
    echo Gdk/UnscaledDPI $((96*1024))
} > "$cfg"
export POLYBAR_DPI="$(echo "$dpi/1.5" | bc)"
systemctl --user import-environment POLYBAR_DPI
if [ ! "$(pgrep -f /usr/bin/xsettingsd|wc -l)" -ge 1 ]; then
    xsettingsd -c "$cfg"
else
    for t in $(pgrep -f xsettingsd); do kill -HUP "$t"; done
fi
