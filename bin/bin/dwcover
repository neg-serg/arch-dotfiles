#!/bin/dash

pushd() {
	SAVE=$(pwd)
	if [ "$1" = "" ]; then
	    if [ "$DSTACK" = "" ]; then
	        echo "pushd: directory stack empty."
			return 1
		fi
		set $DSTACK
		cd $1 || return
		shift 1
		DSTACK="$*"
    else
        cd $1 > /dev/null || return
	fi
	DSTACK="$SAVE $DSTACK"
}

popd() {
	if [ "$DSTACK" = "" ]; then
	    echo "popd: directory stack empty."
		return 1
	fi
	set $DSTACK
	cd $1
	shift
	DSTACK=$*
}

download_cover() {
    default_coversize=400
    default_covername=cover.jpg
    if [ -d "$1" ]; then
        arg1="$1"
    else
        arg1="$PWD"
    fi

    pushd "$(pwd)"
    cd "$arg1"
    data=$(albumdetails ./*)
    artist=$(echo "$data" | rg "Artist" | cut -d ':' -f 2- | xargs)
    album=$(echo "$data" | rg "Album" | cut -d ':' -f 2- | xargs)

    [ "$1" = '-i' ] && sacad "$artist" "$album" "$default_coversize" "$default_covername"

    {
        for flac in *.flac; do
            metaflac --import-picture-from="$default_covername" "$flac"
        done
        for mp3 in *.mp3; do
            eyeD3 --add-image="$default_covername":FRONT_COVER "$mp3"
        done
    } 2> /dev/null
    popd
}

download_cover "$@"
