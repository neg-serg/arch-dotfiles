#!/usr/bin/env python
import sys
import subprocess
import logging
from systemd import journal

def remove_prefix(text, prefix):
    return text[text.startswith(prefix) and len(prefix):]

# Not used now, I think there is no need in this, thx to mpDris2
def compare_images() -> str:
    from PIL import Image
    from imagehash import dhash
    img1,img2=Image.open(sys.argv[1]),Image.open(sys.argv[2])
    if dhash(img1) == dhash(img2):
        return 'fail'
    else:
        return 'ok'

def on_track_change(player, data):
    cover=None
    if data is None or not data:
        log.error('No data')
        sys.exit()
    if 'mpris:artUrl' in data:
        cover=data['mpris:artUrl']
        sys.exit()
    if cover:
        try:
            cover=remove_prefix(cover, 'file://')
            cover_sum=subprocess.check_output(
                ["md5sum", cover]
            ).decode("utf-8").strip()
            md5sums.append(cover_sum.split()[0])
        except subprocess.CalledProcessError:
            log.error('Cannot do mpd5sum for file')
        if player:
            import os
            track_notify=os.path.expanduser('~/bin/track-notify')
            if not md5sums:
                log.error('No md5sums')
                sys.exit()
            elif len(md5sums) == 1:
                subprocess.Popen([track_notify, cover])
            elif md5sums[-1] != md5sums[-2]:
                subprocess.Popen([track_notify, cover])
            del md5sums[:-2]
        else:
            log.error('There is no player')
            sys.exit()
    else:
        log.error('No cover')
        sys.exit()

log=logging.getLogger()
try:
    log.addHandler(journal.JournaldLogHandler())
except:
    log.error('Cannot setup systemd log')

# noqa: E402
try:
    import gi
    gi.require_version('Playerctl', '2.0')
    from gi.repository import Playerctl, GLib
except:
    print('There is no playerctl, abort')
    sys.exit(0)

player=Playerctl.Player()
md5sums=[]

player.connect('metadata', on_track_change)
GLib.MainLoop().run()
